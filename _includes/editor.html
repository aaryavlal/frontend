{% assign default_code = 'fn main() {
    println!("Hello, World!");
}' %}

<div class="embedded-editor-container">
    <div class="editor-wrapper">
        <div class="editor-instance" style="height: 300px; width: 100%;"></div>
        <div class="editor-buttons">
            <button class="copy-btn">Copy</button>
            <button class="run-btn">Run Code</button>
        </div>
    </div>
    <div class="output-panel" style="font-family: monospace;"></div>
</div>

<script>
    // IIFE to initialize the editor for the *last* .embedded-editor-container
    // This script runs right after its container is inserted into the DOM.
    (async function() {
        const container = document.querySelector(
          '.embedded-editor-container:last-of-type'
        );
        if (!container || !container.classList.contains('embedded-editor-container')) return;

        const editorElement = container.querySelector('.editor-instance');
        const runButton = container.querySelector('.run-btn');
        const outputDiv = container.querySelector('.output-panel');
        const copyButton = container.querySelector('.copy-btn');
        const editorWrapper = container.querySelector('.editor-wrapper');
        const editorButtons = container.querySelector('.editor-buttons');

        const rawLang = {{ include.lang | default: "c" | jsonify }};
        const lang = (rawLang === 'c') ? 'c' : 'rust';
        const aceMode = (rawLang === 'c') ? 'c_cpp' : 'rust';
        // this is fine because we only handle C or Rust
        const compiler = (rawLang === 'c') ? 'cg152' : 'r190';


        const inlineCode = {{ include.code | jsonify | default: "null" }};
        const codePath = {{ include.code_path | jsonify | default: "null" }};
        var code;
        if (inlineCode !== null) {
            code = inlineCode;
        } else if (codePath !== null) {
            const res = await fetch(`{{site.baseurl}}/assets/${codePath}`);
            if (!res.ok) throw new Error(`Failed to fetch code from ${codePath}`);
            code = await res.text();
        } else {
            code = default_code;
        }


        // Ace Editor Initialization
        const editor = ace.edit(editorElement);
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode(`ace/mode/${aceMode}`);
        editor.setOptions({
            fontSize: "12pt",
            maxLines: Infinity,
            minLines: 10
        });

        editor.setValue(code);
        editor.clearSelection();

        // Set styles for wrapper and buttons
        editorWrapper.style.position = 'relative';
        editorButtons.style.position = 'absolute';
        editorButtons.style.top = '10px';
        editorButtons.style.right = '10px';
        editorButtons.style.zIndex = '10';
        editorButtons.style.display = 'flex';
        editorButtons.style.gap = '5px';

        // Set initial output style
        outputDiv.style.marginTop = '10px';
        outputDiv.style.marginBottom = '20px';
        outputDiv.style.padding = '10px';
        outputDiv.style.border = '1px solid #ccc';
        outputDiv.style.whiteSpace = 'pre-wrap';
        outputDiv.style.fontSize = '14pt';
        outputDiv.textContent = 'Output will appear here.';
        outputDiv.style.display = 'none';

        // Copy button
        copyButton.addEventListener('click', function() {
            navigator.clipboard.writeText(editor.getValue()).then(function() {
                console.log('Code copied to clipboard');
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
            });
        });

        // Run button
        runButton.addEventListener('click', async function() {
            const code = editor.getValue();
            outputDiv.style.display = 'block';
            outputDiv.textContent = 'Running...';

            try {
                const result = await window.Godbolt.executeCode({
                    source: code,
                    compiler: compiler,
                    lang: lang,
                });
                outputDiv.textContent = window.Godbolt.getResult(result);
            } catch (err) {
              outputDiv.textContent = 'Error: ' + err.message;
            }
        });
    })();
</script>
